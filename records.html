<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情绪记录 - 历史详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style type="text/tailwindcss">
        @layer utilities {
            .emotion-tag {
                @apply text-xs font-medium px-2.5 py-0.5 rounded-full mr-2 mb-2;
            }
            .history-item {
                @apply bg-white rounded-lg shadow-sm p-4 mb-3 transition-all duration-200 hover:shadow-md;
            }
            .date-section {
                @apply mb-6;
            }
            .date-header {
                @apply text-lg font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-200;
            }
            .record-card {
                @apply bg-white rounded-lg shadow-sm p-4 mb-4 transition-all duration-200 hover:shadow-md;
            }
            .emotion-icon {
                @apply w-10 h-10 rounded-full flex items-center justify-center text-lg;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航 -->
    <div class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="history.html" class="text-gray-600 hover:text-gray-800 mr-4">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h1 class="text-xl font-semibold text-gray-800">情绪记录历史</h1>
                </div>
                <div class="text-sm text-gray-500">
                    <span id="total-count">0</span> 条记录
                </div>
            </div>
        </div>
    </div>

    <!-- 日期选择和筛选区域 -->
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">选择日期</label>
                        <input type="date" id="date-picker" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div class="flex gap-2 items-end">
                        <select id="emotion-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">全部情绪</option>
                            <option value="焦虑">焦虑</option>
                            <option value="紧张">紧张</option>
                            <option value="不安">不安</option>
                            <option value="孤独">孤独</option>
                            <option value="沮丧">沮丧</option>
                            <option value="压力">压力</option>
                        </select>
                        <button id="clear-date" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                            清除日期
                        </button>
                    </div>
                </div>
            </div>

        <!-- 统计概览 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-2xl font-bold text-indigo-600" id="stat-total">0</div>
                <div class="text-sm text-gray-600">总记录数</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-2xl font-bold text-green-600" id="stat-bottles">0</div>
                <div class="text-sm text-gray-600">完成瓶子</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-2xl font-bold text-purple-600" id="stat-days">0</div>
                <div class="text-sm text-gray-600">总记录（天）</div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-4">
                <div class="text-2xl font-bold text-orange-600" id="stat-streak">0</div>
                <div class="text-sm text-gray-600">最长连续记录（天）</div>
            </div>
        </div>

        <!-- 情绪分布图表 -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">情绪分布</h2>
            <div class="h-64">
                <canvas id="emotionChart"></canvas>
            </div>
        </div>

        <!-- 历史记录列表 -->
        <div id="records-container">
            <!-- 记录将通过JavaScript动态生成 -->
        </div>

        <!-- 空状态 -->
        <div id="empty-state" class="text-center py-12 hidden">
            <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-600 mb-2">没有找到记录</h3>
            <p class="text-gray-500">尝试调整搜索条件或筛选器</p>
        </div>
    </div>

    <!-- 回到顶部按钮 -->
    <div class="back-to-top" id="backToTop">
        <i class="fas fa-chevron-up"></i>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style>
        /* 回到顶部按钮样式 */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background-color: #4F46E5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        
        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }
        
        .back-to-top:hover {
            background-color: #3730A3;
            transform: translateY(-2px);
        }
        
        .back-to-top:active {
            transform: translateY(0);
        }
    </style>
    <script>
        // 全局变量
        let allRecords = [];
        let filteredRecords = [];

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            setupEventListeners();
        });

        // 加载记录数据
        function loadRecords() {
            const emotionLogs = JSON.parse(localStorage.getItem('emotionLogs') || '[]');
            const completedBottles = JSON.parse(localStorage.getItem('completedBottles') || '[]');
            
            allRecords = emotionLogs;
            filteredRecords = [...allRecords];
            
            updateStats();
            renderEmotionChart();
            renderRecords();
        }

        // 更新统计信息
        function updateStats() {
            const uniqueDays = [...new Set(allRecords.map(record => record.date))].length;
            const completedBottles = JSON.parse(localStorage.getItem('completedBottles') || '[]');
            const streakDays = calculateStreakDays();

            document.getElementById('stat-total').textContent = allRecords.length;
            document.getElementById('stat-days').textContent = uniqueDays;
            document.getElementById('stat-bottles').textContent = completedBottles.length;
            document.getElementById('stat-streak').textContent = streakDays;
            document.getElementById('total-count').textContent = filteredRecords.length;
        }

        // 计算连续记录天数
        function calculateStreakDays() {
            const logs = JSON.parse(localStorage.getItem('emotionLogs') || '[]');
            if (logs.length === 0) return 0;

            const dates = [...new Set(logs.map(log => log.date))].sort();
            let streak = 1;
            let maxStreak = 1;

            for (let i = 1; i < dates.length; i++) {
                const prevDate = new Date(dates[i-1]);
                const currDate = new Date(dates[i]);
                const diffTime = currDate - prevDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 1) {
                    streak++;
                    maxStreak = Math.max(maxStreak, streak);
                } else if (diffDays > 1) {
                    streak = 1;
                }
            }
            return maxStreak;
        }

        // 全局变量存储图表实例
        let emotionChartInstance = null;

        // 渲染情绪图表
        function renderEmotionChart() {
            const emotionData = {};
            const recordsToChart = filteredRecords.length > 0 ? filteredRecords : allRecords;
            
            recordsToChart.forEach(record => {
                emotionData[record.emotion] = (emotionData[record.emotion] || 0) + 1;
            });

            const ctx = document.getElementById('emotionChart').getContext('2d');
            const emotionColors = {
                '焦虑': '#EF4444',
                '紧张': '#F97316',
                '不安': '#EAB308',
                '孤独': '#8B5CF6',
                '沮丧': '#3B82F6',
                '压力': '#6366F1'
            };

            // 销毁旧图表
            if (emotionChartInstance) {
                emotionChartInstance.destroy();
            }

            // 如果没有数据，显示空状态
            if (Object.keys(emotionData).length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            emotionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(emotionData),
                    datasets: [{
                        label: '记录数量',
                        data: Object.values(emotionData),
                        backgroundColor: Object.keys(emotionData).map(emotion => emotionColors[emotion] || '#9CA3AF'),
                        borderColor: Object.keys(emotionData).map(emotion => emotionColors[emotion] || '#9CA3AF'),
                        borderWidth: 1,
                        barPercentage: 0.6,
                        categoryPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            },
                            grid: {
                                display: true,
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // 渲染记录列表
        function renderRecords() {
            const container = document.getElementById('records-container');
            const emptyState = document.getElementById('empty-state');

            if (filteredRecords.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // 按日期分组，并在每个日期内按时间排序（从晚到早）
            const groupedRecords = {};
            filteredRecords.forEach(record => {
                if (!groupedRecords[record.date]) {
                    groupedRecords[record.date] = [];
                }
                groupedRecords[record.date].push(record);
            });

            // 对每个日期内的记录按时间从晚到早排序
            Object.keys(groupedRecords).forEach(date => {
                groupedRecords[date].sort((a, b) => {
                    return b.time.localeCompare(a.time);
                });
            });

            // 按日期排序（降序）
            const sortedDates = Object.keys(groupedRecords).sort((a, b) => new Date(b) - new Date(a));

            let html = '';
            sortedDates.forEach(date => {
                const formattedDate = new Date(date).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });

                const records = groupedRecords[date];
                const recordCount = records.length;

                html += `
                    <div class="date-section">
                        <div class="date-header">
                            ${formattedDate} 
                            <span class="text-sm font-normal text-gray-500">(${recordCount}条记录)</span>
                        </div>
                        <div class="space-y-3">
                            ${records.map(record => `
                                <div class="record-card">
                                    <div class="flex items-start space-x-4">
                                        <div class="emotion-icon ${getEmotionColorClass(record.emotion)}">
                                            ${getEmotionIcon(record.emotion)}
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between">
                                                <h3 class="font-medium text-gray-800">${record.emotion}</h3>
                                                <span class="text-sm text-gray-500">${record.time}</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mt-1">
                                                记录于 ${new Date(record.date).toLocaleDateString('zh-CN')}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 获取情绪颜色类
        function getEmotionColorClass(emotion) {
            const colors = {
                '焦虑': 'bg-red-100 text-red-600',
                '紧张': 'bg-orange-100 text-orange-600',
                '不安': 'bg-yellow-100 text-yellow-600',
                '孤独': 'bg-purple-100 text-purple-600',
                '沮丧': 'bg-blue-100 text-blue-600',
                '压力': 'bg-indigo-100 text-indigo-600'
            };
            return colors[emotion] || 'bg-gray-100 text-gray-600';
        }

        // 获取情绪图标
        function getEmotionIcon(emotion) {
            const icons = {
                '焦虑': '<i class="fas fa-fire-alt"></i>',
                '紧张': '<i class="fas fa-heartbeat"></i>',
                '不安': '<i class="fas fa-exclamation-triangle"></i>',
                '孤独': '<i class="fas fa-user"></i>',
                '沮丧': '<i class="fas fa-cloud-rain"></i>',
                '压力': '<i class="fas fa-bolt"></i>'
            };
            return icons[emotion] || '<i class="fas fa-meh"></i>';
        }

        // 设置事件监听器
        function setupEventListeners() {
            const datePicker = document.getElementById('date-picker');
            const emotionFilter = document.getElementById('emotion-filter');
            const clearDateBtn = document.getElementById('clear-date');
            const backToTopBtn = document.getElementById('backToTop');

            // 日期选择功能
            datePicker.addEventListener('change', filterRecords);
            emotionFilter.addEventListener('change', filterRecords);
            clearDateBtn.addEventListener('click', () => {
                datePicker.value = '';
                filterRecords();
            });

            // 回到顶部功能
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });

            // 监听滚动事件显示/隐藏回到顶部按钮
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            });
        }

        // 筛选记录
        function filterRecords() {
            const selectedDate = document.getElementById('date-picker').value;
            const emotionFilter = document.getElementById('emotion-filter').value;

            filteredRecords = allRecords.filter(record => {
                const matchesDate = !selectedDate || record.date === selectedDate;
                const matchesEmotion = !emotionFilter || record.emotion === emotionFilter;
                return matchesDate && matchesEmotion;
            });

            renderRecords();
            renderEmotionChart();
            document.getElementById('total-count').textContent = filteredRecords.length;
        }
    </script>
</body>
</html>