<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情绪瓶子 - 首页</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style type="text/tailwindcss">
        @layer utilities {
            .emotion-feedback {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px 40px;
                border-radius: 50px;
                font-size: 18px;
                font-weight: 500;
                z-index: 1000;
                opacity: 0;
                transition: all 0.3s ease;
                pointer-events: none;
            }
            .emotion-feedback.show {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            
            /* 深吸气提示样式 */
            .breathe-hint {
                position: fixed;
                top: 30%;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(79, 70, 229, 0.9);
                color: white;
                padding: 15px 30px;
                border-radius: 30px;
                font-size: 16px;
                font-weight: 500;
                z-index: 1000;
                opacity: 0;
                transition: all 0.3s ease;
                pointer-events: none;
            }
            .breathe-hint.show {
                opacity: 1;
            }
            .bottle-container {
                position: relative;
                width: 140px;
                height: 220px;
                margin: 40px auto;
                transition: transform 0.8s ease-in-out;
                transform-origin: bottom center;
            }
            
            .emotion-enter-animation {
                position: fixed !important;
                z-index: 1000;
                transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                animation: emotionFlyToBottle 0.8s ease-in-out forwards;
            }
            
            @keyframes emotionFlyToBottle {
                0% {
                    opacity: 1;
                    transform: scale(1);
                }
                30% {
                    opacity: 0.9;
                    transform: scale(1.2);
                }
                100% {
                    opacity: 0;
                    transform: scale(0.1) translateY(-120px);
                }
            }
            
            @keyframes fadeOut {
                0% { opacity: 1; }
                100% { opacity: 0; }
            }
            
            @keyframes fadeIn {
                0% { opacity: 0; }
                100% { opacity: 1; }
            }
            
            .emotion-fade-out {
                animation: fadeOut 0.3s ease-out forwards;
                pointer-events: none;
            }
            
            .emotion-fade-in {
                animation: fadeIn 0.5s ease-in forwards;
                pointer-events: auto;
            }
            .bottle-shape {
                width: 100%;
                height: 100%;
                position: relative;
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                border-radius: 20px 20px 40px 40px;
                box-shadow: 
                    0 8px 32px rgba(79, 70, 229, 0.2),
                    inset 0 2px 8px rgba(255, 255, 255, 0.6),
                    inset 0 -2px 8px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }
            .bottle-shape::before {
                content: '';
                position: absolute;
                top: -15px;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 30px;
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                border-radius: 30px 30px 0 0;
                box-shadow: 0 -4px 12px rgba(79, 70, 229, 0.2);
            }
            .bottle-glass {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, 
                    rgba(255, 255, 255, 0.3) 0%, 
                    rgba(255, 255, 255, 0.1) 50%, 
                    rgba(255, 255, 255, 0.2) 100%);
                border-radius: inherit;
                pointer-events: none;
            }
            .bottle-fill {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background: linear-gradient(180deg, #4F46E5 0%, #EC4899 50%, #F59E0B 100%);
                transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
                border-radius: 0 0 40px 40px;
                overflow: hidden;
            }

            .bottle-foam {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(
                    ellipse at center,
                    rgba(255, 255, 255, 0.2) 0%,
                    transparent 70%
                );
                animation: foam 4s ease-in-out infinite;
            }
            @keyframes foam {
                0%, 100% { opacity: 0.3; transform: scale(1); }
                50% { opacity: 0.6; transform: scale(1.02); }
            }
            @keyframes fillRipple {
                0% { transform: scale(1); opacity: 0.8; }
                50% { transform: scale(1.05); opacity: 1; }
                100% { transform: scale(1); opacity: 0.8; }
            }
            .bottle-ripple {
                animation: fillRipple 0.6s ease-out;
            }
            .emotion-btn {
                @apply rounded-full py-4 px-8 m-3 text-white shadow-xl transform transition-all duration-300 hover:scale-105 active:scale-95 text-base font-medium;
            }
            .empty-btn {
                @apply bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-8 rounded-full mt-12 shadow-xl transform transition-all duration-300 hover:scale-105 active:scale-95;
                display: none;
                position: relative;
                overflow: hidden;
            }
            
            .empty-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 0%;
                height: 100%;
                background: rgba(255, 255, 255, 0.3);
                transition: width 0.1s ease-out;
                pointer-events: none;
            }
            
            .empty-btn.holding::before {
                width: 100%;
                transition: width 3s linear;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes emptyAnimation {
                0% { height: 100%; opacity: 1; }
                100% { height: 0%; opacity: 0; }
            }
            @keyframes tiltBottle {
                0% { transform: rotate(0deg); }
                30% { transform: rotate(-15deg); }
                70% { transform: rotate(-15deg); }
                100% { transform: rotate(0deg); }
            }
            .bottle-tilt {
                animation: tiltBottle 1.2s ease-in-out;
            }
            .bottle-empty-animation {
                animation: emptyAnimation 1s ease-in-out forwards;
            }
        }
    </style>
</head>
<body class="bg-gray-50 h-full flex flex-col items-center justify-between p-4 pb-20">
    <div id="emotion-feedback" class="emotion-feedback"></div>
    <div id="breathe-hint" class="breathe-hint">深吸气...</div>
        <!-- 说明图标 -->
    <div class="absolute top-4 right-4 z-50">
        <button id="help-icon" class="text-gray-400 hover:text-indigo-600 transition-colors duration-200">
            <i class="fas fa-info-circle text-2xl"></i>
        </button>
    </div>

    <!-- 说明弹窗 -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">使用小贴士</h3>
                <button id="close-help" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-gray-600 leading-relaxed">
                当你正在经历负面情绪时，点击相应的情绪按钮代表你已经觉察到了你的情绪。当累积一定的情绪后，倒空瓶子的仪式也会给你一种暗示：我的坏情绪都烟消云散了。
                <br>
                ---
                <br>                
                把“小瓶子”添加到桌面，方便快速记录情绪。
            </p>
        </div>
    </div>

    <div class="text-center mt-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-2">现在感觉如何？</h2>
        <p class="text-gray-500">选择你正在经历的情绪</p>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center py-8">
        <!-- 瓶子组件 -->
        <div class="bottle-container">
            <div class="bottle-shape">
                <div id="bottle-fill" class="bottle-fill" style="height: 0%">
                    
                </div>
                <div class="bottle-glass"></div>
            </div>
        </div>

        <!-- 清空瓶子按钮 -->
        <button id="empty-bottle" class="empty-btn">
            <i class="fas fa-recycle mr-2"></i>长按清空
        </button>
    </div>

    <!-- 情绪按钮区域 -->
    <div class="grid grid-cols-2 gap-4 mt-6 w-full max-w-md px-4">
        <button class="emotion-btn bg-red-500 hover:bg-red-600" data-emotion="焦虑">
            <i class="fas fa-fire-alt mr-2"></i>焦虑
        </button>
        <button class="emotion-btn bg-orange-500 hover:bg-orange-600" data-emotion="紧张">
            <i class="fas fa-heartbeat mr-2"></i>紧张
        </button>
        <button class="emotion-btn bg-yellow-500 hover:bg-yellow-600" data-emotion="不安">
            <i class="fas fa-exclamation-triangle mr-2"></i>不安
        </button>
        <button class="emotion-btn bg-purple-500 hover:bg-purple-600" data-emotion="孤独">
            <i class="fas fa-user mr-2"></i>孤独
        </button>
        <button class="emotion-btn bg-blue-500 hover:bg-blue-600" data-emotion="沮丧">
            <i class="fas fa-cloud-rain mr-2"></i>沮丧
        </button>
        <button class="emotion-btn bg-indigo-500 hover:bg-indigo-600" data-emotion="压力">
            <i class="fas fa-bolt mr-2"></i>压力
        </button>
    </div>

    <script>
        // 初始化瓶子状态
        let currentFillLevel = parseInt(localStorage.getItem('currentFillLevel')) || 0;
        const maxFillLevel = 10; // 需要10次点击填满
        let currentBottleEmotions = JSON.parse(localStorage.getItem('currentBottleEmotions') || '[]');
        const bottleFillElement = document.getElementById('bottle-fill');
        const emptyButton = document.getElementById('empty-bottle');
        const emotionButtons = document.querySelectorAll('.emotion-btn');
        
        // 添加动画状态控制
        let isAnimating = false;

        // 更新瓶子显示
        function updateBottleDisplay() {
            const percentage = Math.round((currentFillLevel / maxFillLevel) * 100);
            bottleFillElement.style.height = `${percentage}%`;

            // 保存当前瓶子填充状态
            localStorage.setItem('currentFillLevel', currentFillLevel);
            localStorage.setItem('currentBottleEmotions', JSON.stringify(currentBottleEmotions));

            // 检查是否已满
            if (percentage >= 100) {
                emptyButton.style.display = 'block';
                emotionButtons.forEach(btn => btn.style.display = 'none');
                // 瓶子满了时重置动画状态
                isAnimating = false;
            } else {
                emptyButton.style.display = 'none';
                emotionButtons.forEach(btn => btn.style.display = 'block');
            }
        }

        // 情绪按钮点击事件
        emotionButtons.forEach(button => {
            button.addEventListener('click', function() {
                // 防止在动画期间重复点击
                if (currentFillLevel < maxFillLevel && !isAnimating) {
                    const clickedButton = this;
                    const emotion = clickedButton.getAttribute('data-emotion');
                    
                    // 设置动画状态
                    isAnimating = true;
                    
                    // 确保获取准确的按钮位置（在任何样式改变之前）
                    const buttonRect = clickedButton.getBoundingClientRect();
                    const bottleRect = document.querySelector('.bottle-container').getBoundingClientRect();
                    
                    // 计算飞向瓶子的位移
                    const deltaX = bottleRect.left + bottleRect.width/2 - buttonRect.left - buttonRect.width/2;
                    const deltaY = bottleRect.top + bottleRect.height/2 - buttonRect.top - buttonRect.height/2;
                    
                    // 清理可能存在的旧副本按钮
                    const oldFlyingButtons = document.querySelectorAll('.flying-button');
                    oldFlyingButtons.forEach(btn => btn.remove());
                    
                    // 创建被点击按钮的副本用于飞行动画
                    const flyingButton = clickedButton.cloneNode(true);
                    flyingButton.classList.add('flying-button'); // 添加标识类
                    flyingButton.style.position = 'fixed';
                    flyingButton.style.left = buttonRect.left + 'px';
                    flyingButton.style.top = buttonRect.top + 'px';
                    flyingButton.style.width = buttonRect.width + 'px';
                    flyingButton.style.height = buttonRect.height + 'px';
                    flyingButton.style.zIndex = '1000';
                    flyingButton.style.pointerEvents = 'none';
                    document.body.appendChild(flyingButton);
                    
                    // 让所有按钮（包括被点击的）开始消失动画，保持Grid布局稳定
                    emotionButtons.forEach(btn => {
                        btn.classList.add('emotion-fade-out');
                        btn.style.pointerEvents = 'none';
                    });
                    
                    // 添加飞行动画到副本按钮
                    setTimeout(() => {
                        flyingButton.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        flyingButton.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.1)`;
                        flyingButton.style.opacity = '0';
                        
                        // 动画完成后移除副本
                        setTimeout(() => {
                            if (flyingButton && flyingButton.parentNode) {
                                flyingButton.parentNode.removeChild(flyingButton);
                            }
                        }, 800);
                    }, 10);
                    
                    // 动画完成后执行后续操作（调整时间以适应新的动画序列）
                    setTimeout(() => {
                        // 更新瓶子状态
                        currentFillLevel++;
                        updateBottleDisplay();
                        
                        // 添加水波动效果
                        bottleFillElement.classList.add('bottle-ripple');
                        setTimeout(() => {
                            bottleFillElement.classList.remove('bottle-ripple');
                        }, 600);
                        
                        // 记录情绪
                        logEmotion(emotion);
                        
                        // 显示提示，等提示结束后再恢复按钮
                        const feedback = document.getElementById('emotion-feedback');
                        feedback.textContent = `已觉察${emotion}情绪`;
                        feedback.classList.add('show');
                        
                        setTimeout(() => {
                            feedback.classList.remove('show');
                            
                            // 提示结束后才恢复按钮
                        emotionButtons.forEach(btn => {
                            btn.classList.remove('emotion-fade-out');
                            btn.classList.add('emotion-fade-in');
                            // 重置按钮的交互状态
                            btn.style.pointerEvents = '';
                        });
                        
                        setTimeout(() => {
                            emotionButtons.forEach(btn => {
                                btn.classList.remove('emotion-fade-in');
                            });
                            
                            // 重置动画状态，允许新的点击
                            isAnimating = false;
                        }, 500);
                        }, 2000);
                    }, 800); // 恢复原来的时间，因为现在使用副本按钮
                }
            });
        });

        // 显示情绪反馈
        function showEmotionFeedback(emotion) {
            const feedback = document.getElementById('emotion-feedback');
            feedback.textContent = `已觉察${emotion}情绪`;
            feedback.classList.add('show');
            
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2000);
        }

        // 清空瓶子按钮长按事件
        let pressTimer;
        let isPressed = false;
        
        // 通用按下处理函数
        function handlePressStart(e) {
            e.preventDefault();
            isPressed = true;
            
            // 添加按住动画类
            emptyButton.classList.add('holding');
            
            // 显示深吸气提示
            const breatheHint = document.getElementById('breathe-hint');
            breatheHint.classList.add('show');
            
            // 设置3秒计时器
            pressTimer = setTimeout(() => {
                if (isPressed) {
                    // 隐藏深吸气提示
                    breatheHint.classList.remove('show');
                    
                    // 执行清空瓶子操作
                    emptyBottle();
                }
            }, 3000);
        }
        
        // 通用释放处理函数
        function handlePressEnd() {
            isPressed = false;
            clearTimeout(pressTimer);
            
            // 移除按住动画类并重置动画
            emptyButton.classList.remove('holding');
            
            // 隐藏深吸气提示
            const breatheHint = document.getElementById('breathe-hint');
            breatheHint.classList.remove('show');
        }
        
        // PC端事件
        emptyButton.addEventListener('mousedown', handlePressStart);
        emptyButton.addEventListener('mouseup', handlePressEnd);
        emptyButton.addEventListener('mouseleave', handlePressEnd);
        
        // 移动端事件
        emptyButton.addEventListener('touchstart', handlePressStart);
        emptyButton.addEventListener('touchend', handlePressEnd);
        emptyButton.addEventListener('touchcancel', handlePressEnd);
        
        emptyButton.addEventListener('mouseleave', function() {
            isPressed = false;
            clearTimeout(pressTimer);
            
            // 移除按住动画类并重置动画
            emptyButton.classList.remove('holding');
            
            // 隐藏深吸气提示
            const breatheHint = document.getElementById('breathe-hint');
            breatheHint.classList.remove('show');
        });
        
        // 清空瓶子功能
        function emptyBottle() {
            // 添加瓶子倾斜动画
            const bottleContainer = document.querySelector('.bottle-container');
            bottleContainer.classList.add('bottle-tilt');
            
            // 延迟添加倒空动画，让倾斜动画先开始
            setTimeout(() => {
                bottleFillElement.classList.add('bottle-empty-animation');
            }, 300);
            
            // 禁用按钮防止重复点击
            emptyButton.disabled = true;
            
            // 动画完成后重置
            setTimeout(() => {
                currentFillLevel = 0;
                localStorage.setItem('currentFillLevel', 0);
                bottleContainer.classList.remove('bottle-tilt');
                bottleFillElement.classList.remove('bottle-empty-animation');
                updateBottleDisplay();
                recordCompletedBottle();
                emptyButton.disabled = false;
                
                // 显示清空成功提示
                const feedback = document.getElementById('emotion-feedback');
                feedback.textContent = '太好了，坏情绪都烟消云散了！';
                feedback.classList.add('show');
                
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000);
            }, 1200);
        }

        // 记录情绪到本地存储
        function logEmotion(emotion) {
            const now = new Date();
            const dateString = now.toISOString().split('T')[0];
            const timeString = now.toLocaleTimeString();

            let emotionLogs = JSON.parse(localStorage.getItem('emotionLogs') || '[]');
            emotionLogs.push({
                date: dateString,
                time: timeString,
                emotion: emotion
            });
            localStorage.setItem('emotionLogs', JSON.stringify(emotionLogs));
            
            // 添加到当前瓶子情绪列表
            currentBottleEmotions.push(emotion);
        }

        // 记录完成的瓶子
        function recordCompletedBottle() {
            const now = new Date();
            const dateString = now.toISOString().split('T')[0];
            const timeString = now.toLocaleTimeString();

            let completedBottles = JSON.parse(localStorage.getItem('completedBottles') || '[]');
            completedBottles.push({
                date: dateString,
                time: timeString,
                entries: currentBottleEmotions.map(emotion => ({
                    emotion: emotion,
                    date: dateString,
                    time: timeString
                }))
            });
            localStorage.setItem('completedBottles', JSON.stringify(completedBottles));
            
            // 清空当前瓶子情绪
            currentBottleEmotions = [];
            localStorage.setItem('currentBottleEmotions', JSON.stringify(currentBottleEmotions));
        }

        // 初始化页面
        updateBottleDisplay();

        // 说明图标点击事件
        document.getElementById('help-icon').addEventListener('click', function() {
            document.getElementById('help-modal').classList.remove('hidden');
        });

        // 关闭说明弹窗
        document.getElementById('close-help').addEventListener('click', function() {
            document.getElementById('help-modal').classList.add('hidden');
        });

        // 点击弹窗外部关闭
        document.getElementById('help-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });
    </script>
</body>
</html>