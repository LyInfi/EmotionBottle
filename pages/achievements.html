<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的成就 - 情绪记录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../config/tailwind-config.js"></script>
    <script>
        if (window.tailwindConfig) {
            tailwind.config = window.tailwindConfig;
        }
    </script>
    <link rel="stylesheet" href="../assets/css/common.css">
    <script src="../assets/js/common.js"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            .achievement-card {
                @apply bg-white rounded-lg shadow-sm p-6 transition-all duration-300 hover:shadow-md;
            }
            .achievement-card.unlocked {
                @apply border-2 border-green-500 bg-green-50;
            }
            .achievement-card.locked {
                @apply opacity-75;
            }
            .progress-bar {
                @apply w-full bg-gray-200 rounded-full h-2;
            }
            .progress-fill {
                @apply bg-green-500 h-2 rounded-full transition-all duration-300;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航 -->
    <div class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center">
                <a href="history.html" class="text-gray-600 hover:text-gray-800 mr-4">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-xl font-semibold text-gray-800">我的成就</h1>
            </div>
        </div>
    </div>

    <!-- 成就统计 -->
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">成就进度</h2>
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-2xl font-bold text-indigo-600" id="unlocked-count">0</p>
                    <p class="text-sm text-gray-600">已解锁成就</p>
                </div>
                <div class="text-right">
                    <p class="text-2xl font-bold text-gray-400">10</p>
                    <p class="text-sm text-gray-600">总成就数</p>
                </div>
            </div>
            <div class="mt-4">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2" id="progress-text">0% 完成</p>
            </div>
        </div>

        <!-- 成就列表 -->
        <div class="space-y-4">
            <!-- 情绪启蒙 -->
            <div class="achievement-card" data-achievement="emotion-novice">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center text-2xl text-indigo-600">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">情绪启蒙</h3>
                        <p class="text-sm text-gray-600 mt-1">开始记录你的第一个情绪</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-novice">0/1</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-novice" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-novice">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 瓶满则溢 -->
            <div class="achievement-card" data-achievement="bottle-collector">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-2xl text-blue-600">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">瓶满则溢</h3>
                        <p class="text-sm text-gray-600 mt-1">完成你的第一个情绪瓶子</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-bottle">0/1</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-bottle" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-bottle">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 坚持不懈 -->
            <div class="achievement-card" data-achievement="consistent-recorder">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center text-2xl text-green-600">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">坚持不懈</h3>
                        <p class="text-sm text-gray-600 mt-1">连续记录情绪3天</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-consistent">0/3</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-consistent" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-consistent">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 情绪大师 -->
            <div class="achievement-card" data-achievement="emotion-master">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-yellow-100 flex items-center justify-center text-2xl text-yellow-600">
                        <i class="fas fa-award"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">情绪大师</h3>
                        <p class="text-sm text-gray-600 mt-1">记录10个情绪并完成5个瓶子</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-master">0/10 记录, 0/5 瓶子</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-master" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-master">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 纯焦虑瓶 -->
            <div class="achievement-card" data-achievement="pure-anxiety">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center text-2xl text-red-600">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">焦虑净化者</h3>
                        <p class="text-sm text-gray-600 mt-1">完成一个只包含焦虑情绪的瓶子</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-pure-anxiety">0/1</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-pure-anxiety" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-pure-anxiety">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 纯紧张瓶 -->
            <div class="achievement-card" data-achievement="pure-tension">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-orange-100 flex items-center justify-center text-2xl text-orange-600">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">紧张释放者</h3>
                        <p class="text-sm text-gray-600 mt-1">完成一个只包含紧张情绪的瓶子</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-pure-tension">0/1</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-pure-tension" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-pure-tension">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 纯不安瓶 -->
            <div class="achievement-card" data-achievement="pure-unease">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-yellow-100 flex items-center justify-center text-2xl text-yellow-600">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">不安平息者</h3>
                        <p class="text-sm text-gray-600 mt-1">完成一个只包含不安情绪的瓶子</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-pure-unease">0/1</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-pure-unease" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-pure-unease">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 纯孤独瓶 -->
            <div class="achievement-card" data-achievement="pure-loneliness">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-purple-100 flex items-center justify-center text-2xl text-purple-600">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">孤独驱散者</h3>
                        <p class="text-sm text-gray-600 mt-1">完成一个只包含孤独情绪的瓶子</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-pure-loneliness">0/1</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-pure-loneliness" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-pure-loneliness">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 纯沮丧瓶 -->
            <div class="achievement-card" data-achievement="pure-depression">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-2xl text-blue-600">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">沮丧化解者</h3>
                        <p class="text-sm text-gray-600 mt-1">完成一个只包含沮丧情绪的瓶子</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-pure-depression">0/1</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-pure-depression" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-pure-depression">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 纯压力瓶 -->
            <div class="achievement-card" data-achievement="pure-pressure">
                <div class="flex items-start space-x-4">
                    <div class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center text-2xl text-indigo-600">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800">压力释放者</h3>
                        <p class="text-sm text-gray-600 mt-1">完成一个只包含压力情绪的瓶子</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">进度</span>
                                <span id="progress-pure-pressure">0/1</span>
                            </div>
                            <div class="progress-bar mt-1">
                                <div class="progress-fill" id="fill-pure-pressure" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl text-gray-400" id="status-pure-pressure">
                            <i class="fas fa-lock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 成就系统管理类
        class AchievementManager {
            constructor() {
                this.totalAchievements = 10;
                this.emotionMapping = {
                    '焦虑': 'pureAnxiety',
                    '紧张': 'pureTension',
                    '不安': 'pureUnease',
                    '孤独': 'pureLoneliness',
                    '沮丧': 'pureDepression',
                    '压力': 'purePressure'
                };

                this.achievementConfigs = {
                    'emotion-novice': {
                        checker: (data) => data.totalRecords >= 1,
                        progressCalc: (data) => Math.min(data.totalRecords, 1),
                        maxValue: 1,
                        progressText: (progress, max) => `${progress}/${max}`
                    },
                    'bottle-collector': {
                        checker: (data) => data.totalBottles >= 1,
                        progressCalc: (data) => Math.min(data.totalBottles, 1),
                        maxValue: 1,
                        progressText: (progress, max) => `${progress}/${max}`
                    },
                    'consistent-recorder': {
                        checker: (data) => data.streak >= 3,
                        progressCalc: (data) => Math.min(data.streak, 3),
                        maxValue: 3,
                        progressText: (progress, max) => `${progress}/${max}`
                    },
                    'emotion-master': {
                        checker: (data) => data.totalRecords >= 10 && data.totalBottles >= 5,
                        progressCalc: (data) => ({ records: Math.min(data.totalRecords, 10), bottles: Math.min(data.totalBottles, 5) }),
                        maxValue: { records: 10, bottles: 5 },
                        progressText: (progress, max) => `${progress.records}/${max.records} 记录, ${progress.bottles}/${max.bottles} 瓶子`,
                        percentageCalc: (data) => Math.min(((data.totalRecords / 10) + (data.totalBottles / 5)) / 2 * 100, 100)
                    },
                    'pure-anxiety': {
                        checker: (data) => data.pureAnxiety,
                        progressCalc: (data) => data.pureAnxiety ? 1 : 0,
                        maxValue: 1,
                        progressText: (progress, max) => `${progress}/${max}`
                    },
                    'pure-tension': {
                        checker: (data) => data.pureTension,
                        progressCalc: (data) => data.pureTension ? 1 : 0,
                        maxValue: 1,
                        progressText: (progress, max) => `${progress}/${max}`
                    },
                    'pure-unease': {
                        checker: (data) => data.pureUnease,
                        progressCalc: (data) => data.pureUnease ? 1 : 0,
                        maxValue: 1,
                        progressText: (progress, max) => `${progress}/${max}`
                    },
                    'pure-loneliness': {
                        checker: (data) => data.pureLoneliness,
                        progressCalc: (data) => data.pureLoneliness ? 1 : 0,
                        maxValue: 1,
                        progressText: (progress, max) => `${progress}/${max}`
                    },
                    'pure-depression': {
                        checker: (data) => data.pureDepression,
                        progressCalc: (data) => data.pureDepression ? 1 : 0,
                        maxValue: 1,
                        progressText: (progress, max) => `${progress}/${max}`
                    },
                    'pure-pressure': {
                        checker: (data) => data.purePressure,
                        progressCalc: (data) => data.purePressure ? 1 : 0,
                        maxValue: 1,
                        progressText: (progress, max) => `${progress}/${max}`
                    }
                };
            }

            // 获取本地数据
            getLocalData() {
                return {
                    emotionLogs: JSON.parse(localStorage.getItem('emotionLogs') || '[]'),
                    completedBottles: JSON.parse(localStorage.getItem('completedBottles') || '[]')
                };
            }

            // 获取成就数据
            getAchievementData() {
                const { emotionLogs, completedBottles } = this.getLocalData();

                return {
                    totalRecords: emotionLogs.length,
                    totalBottles: completedBottles.length,
                    streak: this.calculateStreakDays(emotionLogs),
                    uniqueDates: [...new Set(emotionLogs.map(log => log.date))].length,
                    ...this.calculatePureEmotionAchievements(completedBottles)
                };
            }

            // 计算连续记录天数
            calculateStreakDays(emotionLogs) {
                if (emotionLogs.length === 0) return 0;

                const uniqueDates = [...new Set(emotionLogs.map(log => log.date))].sort();
                let streak = 1;
                let maxStreak = 1;

                for (let i = 1; i < uniqueDates.length; i++) {
                    const prevDate = new Date(uniqueDates[i-1]);
                    const currDate = new Date(uniqueDates[i]);
                    const diffDays = Math.ceil((currDate - prevDate) / (1000 * 60 * 60 * 24));

                    if (diffDays === 1) {
                        streak++;
                        maxStreak = Math.max(maxStreak, streak);
                    } else if (diffDays > 1) {
                        streak = 1;
                    }
                }

                return maxStreak;
            }

            // 计算单一情绪瓶子成就
            calculatePureEmotionAchievements(completedBottles) {
                const achievements = {
                    pureAnxiety: false,
                    pureTension: false,
                    pureUnease: false,
                    pureLoneliness: false,
                    pureDepression: false,
                    purePressure: false
                };

                completedBottles.forEach(bottle => {
                    if (bottle.entries && bottle.entries.length > 0) {
                        const emotions = bottle.entries.map(entry => entry.emotion);
                        const uniqueEmotions = [...new Set(emotions)];

                        if (uniqueEmotions.length === 1) {
                            const emotion = uniqueEmotions[0];
                            const achievementKey = this.emotionMapping[emotion];
                            if (achievementKey) {
                                achievements[achievementKey] = true;
                            }
                        }
                    }
                });

                return achievements;
            }

            // 更新单个成就状态
            updateSingleAchievement(achievementKey, data) {
                const config = this.achievementConfigs[achievementKey];
                if (!config) return false;

                const isUnlocked = config.checker(data);
                const progress = config.progressCalc(data);
                const maxValue = config.maxValue;

                // 更新进度文本
                const progressElement = document.getElementById(`progress-${achievementKey.replace(/-/g, '-')}`);
                if (progressElement) {
                    progressElement.textContent = config.progressText(progress, maxValue);
                }

                // 更新进度条
                const fillElement = document.getElementById(`fill-${achievementKey.replace(/-/g, '-')}`);
                if (fillElement) {
                    let percentage;
                    if (config.percentageCalc) {
                        percentage = config.percentageCalc(data);
                    } else if (typeof progress === 'object') {
                        // 处理复杂进度计算（如情绪大师）
                        percentage = Math.min(((progress.records / maxValue.records) + (progress.bottles / maxValue.bottles)) / 2 * 100, 100);
                    } else {
                        percentage = typeof maxValue === 'number' ? (progress / maxValue) * 100 : progress * 100;
                    }
                    fillElement.style.width = `${percentage}%`;
                }

                // 更新状态图标
                const statusElement = document.getElementById(`status-${achievementKey.replace(/-/g, '-')}`);
                if (statusElement) {
                    statusElement.innerHTML = isUnlocked ?
                        '<i class="fas fa-unlock text-green-500"></i>' :
                        '<i class="fas fa-lock text-gray-400"></i>';
                }

                // 更新成就卡片样式
                const cardElement = document.querySelector(`[data-achievement="${achievementKey}"]`);
                if (cardElement) {
                    cardElement.classList.toggle('unlocked', isUnlocked);
                }

                return isUnlocked;
            }

            // 更新所有成就状态
            updateAchievements() {
                const data = this.getAchievementData();
                let unlockedCount = 0;

                // 遍历所有成就配置并更新
                Object.keys(this.achievementConfigs).forEach(achievementKey => {
                    if (this.updateSingleAchievement(achievementKey, data)) {
                        unlockedCount++;
                    }
                });

                // 更新总进度
                this.updateOverallProgress(unlockedCount);
            }

            // 更新总体进度
            updateOverallProgress(unlockedCount) {
                const totalProgress = (unlockedCount / this.totalAchievements) * 100;

                const elements = {
                    count: document.getElementById('unlocked-count'),
                    fill: document.getElementById('progress-fill'),
                    text: document.getElementById('progress-text')
                };

                if (elements.count) elements.count.textContent = unlockedCount;
                if (elements.fill) elements.fill.style.width = `${totalProgress}%`;
                if (elements.text) elements.text.textContent = `${Math.round(totalProgress)}% 完成`;
            }
        }

        // 全局实例
        let achievementManager;

        // 兼容性函数（保持向后兼容）
        function getAchievementData() {
            return achievementManager?.getAchievementData() || {};
        }

        function updateAchievements() {
            achievementManager?.updateAchievements();
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            achievementManager = new AchievementManager();
            achievementManager.updateAchievements();
        });
    </script>
</body>
</html>